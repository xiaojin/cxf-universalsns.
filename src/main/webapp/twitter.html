<html>
	<head>
		<title>OAuthSimple w/ LinkedIn</title>
		<script src="js/libs/jquery-2.1.0.js"></script>
		<script src="OAuthSimple.js"></script>
		<script>
			/*
			 You must edit the two following lines and put in your consumer key and shared secret
			 */
			var consumer_key = "0Knzh0Sj8Ngb2mY8mT6WA";
			var shared_secret = "uswOAaTiC9DLiwwjanUU4pIZB77GmGzc3EMbY7t8";
			var proxy = "http://ec2-54-201-88-26.us-west-2.compute.amazonaws.com:8080/AccessToken"
			proxy="http://localhost:9090/AccessToken";
			var callbackUrl = "http://ec2-54-201-88-26.us-west-2.compute.amazonaws.com:8080/twitter.html";
			callbackUrl = "http://localhost:9090/twitter.html";

			/*

			 Nothing below here needs to be edited for the demo to operate

			 */

			var oauth = OAuthSimple(consumer_key, shared_secret);

			function queryString(query) {
				// This function is anonymous, is executed immediately and
				// the return value is assigned to QueryString!
				var query_string = {};
				var vars = query.split("&");
				for (var i = 0; i < vars.length; i++) {
					var pair = vars[i].split("=");
					// If first entry with this name
					if ( typeof query_string[pair[0]] === "undefined") {
						query_string[pair[0]] = pair[1];
						// If second entry with this name
					} else if ( typeof query_string[pair[0]] === "string") {
						var arr = [query_string[pair[0]], pair[1]];
						query_string[pair[0]] = arr;
						// If third or later entry with this name
					} else {
						query_string[pair[0]].push(pair[1]);
					}
				}
				return query_string;
			}

			function start() {
				oauth.reset();
				var url = oauth.sign({
					action : "GET",
					path : "https://api.twitter.com/oauth/request_token",
					parameters : {
						oauth_callback : callbackUrl
					}
				}).signed_url;
				console.log(url);
				$.ajax({

					// The 'type' property sets the HTTP method.
					// A value of 'PUT' or 'DELETE' will trigger a preflight request.
					type : 'GET',

					// The URL to make the request to.
					url : proxy+"?url=" + escape(url),

					// The 'contentType' property sets the 'Content-Type' header.
					// The JQuery default for this property is
					// 'application/x-www-form-urlencoded; charset=UTF-8', which does not trigger
					// a preflight. If you set this value to anything other than
					// application/x-www-form-urlencoded, multipart/form-data, or text/plain,
					// you will trigger a preflight request.
					contentType : 'text/plain',

					xhrFields : {
						// The 'xhrFields' property sets additional fields on the XMLHttpRequest.
						// This can be used to set the 'withCredentials' property.
						// Set the value to 'true' if you'd like to pass cookies to the server.
						// If this is enabled, your server must respond with the header
						// 'Access-Control-Allow-Credentials: true'.
						withCredentials : false
					},

					headers : {
						// Set any custom headers here.
						// If you set any non-simple headers, your server must include these
						// headers in the 'Access-Control-Allow-Headers' response header.
					},

					success : function(data) {
						// Here's where you handle a successful response.
						console.log(data);
						var oauth_information = {};
						localStorage.setItem("1", "1");
						data.replace(new RegExp("([^?=&]+)(=([^&]*))?", "g"), function($0, $1, $2, $3) {
							oauth_information[$1] = $3;
						});
/* 						var thatWindow = window.open("https://api.twitter.com/oauth/authenticate?oauth_token=" + oauth_information.oauth_token);
 */						window.location.href="https://api.twitter.com/oauth/authenticate?oauth_token=" + oauth_information.oauth_token,_self;
						var interval = setInterval(function() {
							if (localStorage.getItem(oauth_information.oauth_token) != null) {
								//var query = thatWindow.location.search.substring(1);
								//thatWindow.close();
								clearInterval(interval);
								//alert(localStorage.getItem(oauth_information.oauth_token));
								getAccessToken(oauth_information, localStorage.getItem(oauth_information.oauth_token));
							}
						}, 500);
					},

					error : function() {
						// Here's where you handle an error response.
						// Note that if the error was due to a CORS issue,
						// this function will still fire, but there won't be any additional
						// information about the error.
					}
				});
			}

			function getAccessToken(oauth_information, verifier) {
				oauth.reset();

				var url = oauth.sign({
					action : "GET",
					path : "https://api.twitter.com/oauth/access_token",
					parameters : {
						oauth_verifier : verifier
					},
					signatures : oauth_information
				}).signed_url;
				console.log(url);
				$.ajax({

					// The 'type' property sets the HTTP method.
					// A value of 'PUT' or 'DELETE' will trigger a preflight request.
					type : 'GET',

					// The URL to make the request to.
					url : proxy+"?url=" + escape(url),

					// The 'contentType' property sets the 'Content-Type' header.
					// The JQuery default for this property is
					// 'application/x-www-form-urlencoded; charset=UTF-8', which does not trigger
					// a preflight. If you set this value to anything other than
					// application/x-www-form-urlencoded, multipart/form-data, or text/plain,
					// you will trigger a preflight request.
					contentType : 'text/plain',

					xhrFields : {
						// The 'xhrFields' property sets additional fields on the XMLHttpRequest.
						// This can be used to set the 'withCredentials' property.
						// Set the value to 'true' if you'd like to pass cookies to the server.
						// If this is enabled, your server must respond with the header
						// 'Access-Control-Allow-Credentials: true'.
						withCredentials : false
					},

					headers : {
						// Set any custom headers here.
						// If you set any non-simple headers, your server must include these
						// headers in the 'Access-Control-Allow-Headers' response header.
					},

					success : function(data) {
						// Here's where you handle a successful response.
						console.log(data);
						data.replace(new RegExp("([^?=&]+)(=([^&]*))?", "g"), function($0, $1, $2, $3) {
							oauth_information[$1] = $3;
						});
						listFav(oauth_information);
					},

					error : function() {
						// Here's where you handle an error response.
						// Note that if the error was due to a CORS issue,
						// this function will still fire, but there won't be any additional
						// information about the error.
					}
				});

			}

			function listFav(oauth_information) {
				oauth.reset();
				var sourceUrl = document.getElementById("source-url").value;
				var parameters = document.getElementById("parameters").value;
				var action = document.getElementById("action").value;

				var url = oauth.sign({
					action : action,
					path : sourceUrl,
					parameters : parameters,
					signatures : oauth_information
				}).signed_url;
				console.log(url);
				$.ajax({

					// The 'type' property sets the HTTP method.
					// A value of 'PUT' or 'DELETE' will trigger a preflight request.
					type : 'GET',

					// The URL to make the request to.
					url : proxy+"?url=" + escape(url),

					// The 'contentType' property sets the 'Content-Type' header.
					// The JQuery default for this property is
					// 'application/x-www-form-urlencoded; charset=UTF-8', which does not trigger
					// a preflight. If you set this value to anything other than
					// application/x-www-form-urlencoded, multipart/form-data, or text/plain,
					// you will trigger a preflight request.
					contentType : 'text/plain',

					xhrFields : {
						// The 'xhrFields' property sets additional fields on the XMLHttpRequest.
						// This can be used to set the 'withCredentials' property.
						// Set the value to 'true' if you'd like to pass cookies to the server.
						// If this is enabled, your server must respond with the header
						// 'Access-Control-Allow-Credentials: true'.
						withCredentials : false
					},

					headers : {
						// Set any custom headers here.
						// If you set any non-simple headers, your server must include these
						// headers in the 'Access-Control-Allow-Headers' response header.
					},

					success : function(data) {
						// Here's where you handle a successful response.
						console.log(data);
						alert("Fav List Success");
						alert(data);
					},

					error : function() {
						// Here's where you handle an error response.
						// Note that if the error was due to a CORS issue,
						// this function will still fire, but there won't be any additional
						// information about the error.
					}
				});
			}

			$(function() {
				$("#start").click(start);
				var search = window.location.search;
				var query = "";
				if (search.length > 0) {
					query = search.substring(1);
					var q = queryString(query);
					localStorage.setItem(q.oauth_token, q.oauth_verifier);
/* 					window.close();
 */				}
			});
		</script>
	</head>
	<body>
		<h1>OAuthSimple w/ Twitter</h1>
		Set Action, Source URL and Parameters below and click <b>Start Test</b>
		<br>
		<br>
		Action:
		<input id="action" style="width:500px;" value="GET">
		</input>
		GET or POST
		<br>
		<br>
		Source URL:
		<input id="source-url" style="width:500px;" value="https://api.twitter.com/1.1/favorites/list.json">
		</input>
		The Twitter API, find more on linkedin developer site.
		<br>
		<br>
		Parameters:
		<input id="parameters" style="width:500px;" value="count=10">
		</input>
		count=10&a=1&b=2
		<br>
		<Button id="start">Start Test</Button>
	</body>
</html>
